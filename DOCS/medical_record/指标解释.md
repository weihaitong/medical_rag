***

# 大模型推理引擎监控指标详解指南

**文档版本**: v1.0
**适用范围**: SGLang, vLLM, MindIE 推理服务监控
**用途**: 帮助运维与开发人员理解原生 Prometheus Metrics 含义，用于构建 Grafana 大盘及配置告警。

-----

## 1. SGLang 监控指标详解
*(对应图片 1-3 内容)*

SGLang 的指标非常细致，特别是在 RadixAttention（前缀缓存）和队列调度方面提供了深入的各类计数器。

### 1.1 流量与并发 (Traffic & Concurrency)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`sglang:num_requests_total`** | Counter | **请求总数**。服务端收到的所有请求总量（入口流量）。 |
| **`sglang:num_running_reqs`** | Gauge | **正在运行的请求数**。当前正在 GPU 上进行推理（Prefill 或 Decode）的并发数。 |
| **`sglang:num_queue_reqs`** | Gauge | **排队请求数**。已接收但在等待队列中，尚未分配到资源的请求数。**扩容核心指标**。 |
| **`sglang:num_grammar_queue_reqs`** | Gauge | **语法约束排队数**。使用 Grammar（如 JSON 模式）约束时，处于专用等待队列的请求数。 |
| **`sglang:num_running_reqs_offline_batch`** | Gauge | **离线批处理运行数**。标记为低优先级/离线批处理任务的并发运行数。 |
| **`sglang:num_paused_reqs`** | Gauge | **暂停请求数**。因显存不足被暂时挂起（Paused）的请求数。 |
| **`sglang:num_retracted_reqs`** | Gauge | **撤回请求数**。因 RadixAttention 机制或其他调度原因被撤回的请求数。 |

### 1.2 显存与 Token 状态 (Memory & Tokens)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`sglang:num_used_tokens`** | Gauge | **已用 Token 数**。当前显存池（KV Cache）中实际存储的 Token 总量。 |
| **`sglang:max_total_num_tokens`** | Gauge | **最大 Token 容量**。显存池能容纳的 Token 总上限。**显存利用率 = num_used / max_total**。 |
| **`sglang:token_usage`** | Gauge | **Token 使用量**。当前系统整体的 Token 占用情况。 |
| **`sglang:pending_prealloc_token_usage`** | Gauge | **待预分配 Token 量**。已计划分配但尚未实际写入显存的 Token 占用。 |
| **`sglang:cache_hit_rate`** | Gauge | **缓存命中率**。RadixAttention (前缀缓存) 的命中率。越高说明 Prompt 复用越好，Prefill 越快。 |
| **`sglang:new_token_ratio`** | Gauge | **新 Token 比例**。生成的 Token 与输入 Token 的比例关系。 |

### 1.3 吞吐量 (Throughput)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`sglang:gen_throughput`** | Gauge | **生成吞吐率 (Token/s)**。当前每秒生成的 Output Token 数量。衡量系统产出能力。 |
| **`sglang:prompt_tokens_total`** | Counter | **输入 Token 总量**。累计处理的 Prompt Token 数量。 |
| **`sglang:generation_tokens_total`** | Counter | **输出 Token 总量**。累计生成的 Generation Token 数量。 |

### 1.4 时延 (Latency)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`sglang:time_to_first_token_seconds`** | Histogram | **首字时延 (TTFT)**。从请求到达直到生成第一个 Token 的耗时。用户体验最关键指标。 |
| **`sglang:inter_token_latency_seconds`** | Histogram | **字间时延 (TPOT)**。生成两个 Token 之间的时间间隔。衡量生成的流畅度。 |
| **`sglang:e2e_request_latency_seconds`** | Histogram | **端到端时延**。请求从开始到完全结束的总耗时。 |
| **`sglang:queue_time_seconds`** | Histogram | **排队耗时**。请求在队列中等待被调度的时间。 |
| **`sglang:per_stage_req_latency_seconds`** | Histogram | **阶段耗时**。请求在 Prefill 或 Decode 各个阶段的具体耗时分布。 |

### 1.5 高级特性与系统 (Advanced & System)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`sglang:spec_accept_length`** | Gauge | **投机采样接受长度**。使用投机采样时，平均每次接受的 Token 长度。 |
| **`sglang:spec_accept_rate`** | Gauge | **投机采样接受率**。投机采样预测的准确率。 |
| **`sglang:kv_transfer_speed_gb_s`** | Gauge | **KV 传输速度**。如果开启了分离式部署，KV Cache 在不同实例间传输的速度。 |
| **`sglang:utilization`** | Gauge | **系统综合利用率**。GPU 计算资源的繁忙程度。 |
| **`sglang:engine_startup_time`** | Gauge | **引擎启动耗时**。服务进程启动所需时间。 |
| **`sglang:engine_load_weights_time`** | Gauge | **模型加载耗时**。加载模型权重文件所需时间。 |

---

## 2. vLLM 监控指标详解
*(对应图片 4-9 内容)*

vLLM 的指标覆盖了从 Python 运行时、系统资源到推理核心性能的全链路。

### 2.1 推理核心指标 (Inference Core)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`vllm:num_requests_running`** | Gauge | **运行中请求数**。当前正在 GPU 上计算的请求数。 |
| **`vllm:num_requests_waiting`** | Gauge | **等待中请求数**。队列中积压的请求数。**由 0 变大意味着系统过载**。 |
| **`vllm:num_preemptions_total`** | Counter | **抢占总次数**。因显存不足导致正在运行的请求被强制停止并换出（Swap out）的次数。理想情况应为 0。 |
| **`vllm:request_success_total`** | Counter | **请求成功总数**。成功完成并返回 200 OK 的请求总量（出口流量）。 |
| **`vllm:prompt_tokens_total`** | Counter | **输入 Token 总量**。累计处理的 Prompt Token。 |
| **`vllm:generation_tokens_total`** | Counter | **输出 Token 总量**。累计生成的 Generation Token。 |

### 2.2 显存与缓存 (GPU Memory & Cache)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`vllm:gpu_cache_usage_perc`** | Gauge | **GPU KV Cache 利用率**。0.0 到 1.0。接近 1.0 时容易发生抢占。 |
| **`vllm:prefix_cache_hit_rate`** | Gauge | **前缀缓存命中率**。命中缓存的 Token 比例。命中率高可显著降低 TTFT。 |
| **`vllm:kv_cache_usage_perc`** | Gauge | **KV Cache 利用率** (通用)。通常等同于 GPU cache usage。 |

### 2.3 时延分布 (Latency Histogram)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`vllm:time_to_first_token_seconds`** | Histogram | **首字时延 (TTFT)**。 |
| **`vllm:time_per_output_token_seconds`** | Histogram | **字间时延 (TPOT)**。生成每个 Token 的耗时。 |
| **`vllm:e2e_request_latency_seconds`** | Histogram | **端到端总时延**。 |
| **`vllm:request_queue_time_seconds`** | Histogram | **请求排队时间**。在调度队列中等待的时间。 |
| **`vllm:request_inference_time_seconds`**| Histogram | **纯推理时间**。E2E 时间减去排队时间，即 GPU 实际工作的时间。 |
| **`vllm:request_prefill_time_seconds`** | Histogram | **预填充(Prefill)阶段耗时**。处理 Prompt 的时间。 |
| **`vllm:request_decode_time_seconds`** | Histogram | **解码(Decode)阶段耗时**。生成 Response 的时间。 |

### 2.4 请求特征统计 (Request Stats)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`vllm:request_prompt_tokens`** | Histogram | **输入长度分布**。用户输入的 Prompt 有多长。 |
| **`vllm:request_generation_tokens`** | Histogram | **输出长度分布**。模型生成的答案有多长。 |
| **`vllm:request_params_max_tokens`** | Histogram | **Max Tokens 参数分布**。用户请求中设置的 `max_tokens` 参数值分布。 |
| **`vllm:iteration_tokens_total`** | Histogram | **批处理 Token 数**。调度器每次迭代（Step）处理的总 Token 数。反映 Batch Size 的大小。 |

### 2.5 系统与运行时 (System & Runtime)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`python_gc_collections_total`** | Counter | **GC 次数**。Python 垃圾回收触发次数。过于频繁会引起卡顿。 |
| **`process_cpu_seconds_total`** | Counter | **CPU 使用时间**。进程占用的 CPU 时间片总和。 |
| **`process_resident_memory_bytes`** | Gauge | **物理内存占用 (RSS)**。进程占用的主机内存大小。 |
| **`http_requests_total`** | Counter | **HTTP 请求总数**。API Server 层面的请求计数（含 Metrics 抓取等）。 |
| **`http_request_duration_seconds`** | Histogram | **HTTP 响应耗时**。API 层面的耗时（包含序列化/网络开销，通常略大于推理时延）。 |

---

## 3. MindIE 监控指标详解
*(对应图片 10-12 内容)*

MindIE 是华为昇腾 (Ascend) 生态的推理引擎，其指标定义贴近 vLLM 但有特定的 NPU 相关指标。

### 3.1 计数器与状态 (Counters & Status)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`request_received_total`** | Counter | **已接收请求总数**。服务端收到的所有请求（入口流量）。 |
| **`request_success_total`** | Counter | **请求成功总数**。成功推理完成的请求（出口流量）。 |
| **`request_failed_total`** | Counter | **请求失败总数**。发生错误（如 5xx, 4xx）的请求数。 |
| **`num_requests_running`** | Gauge | **运行中请求数**。当前 NPU 上正在处理的请求并发数。 |
| **`num_requests_waiting`** | Gauge | **等待中请求数**。调度队列中的排队数量。 |
| **`num_requests_swapped`** | Gauge | **被换出请求数**。因显存不足，上下文被换出到 CPU 内存的请求数。 |
| **`num_preemptions_total`** | Counter | **抢占累计次数**。累计发生的抢占事件次数。 |

### 3.2 吞吐与利用率 (Throughput & Usage)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`prompt_tokens_total`** | Counter | **输入 Token 总量**。累计处理的 Prompt Token。 |
| **`generation_tokens_total`** | Counter | **输出 Token 总量**。累计生成的 Generation Token。 |
| **`avg_prompt_throughput_toks_per_s`**| Gauge | **平均 Prefill 吞吐率**。处理输入 Token 的实时速率 (tokens/s)。 |
| **`avg_generation_throughput_toks_per_s`**| Gauge| **平均 Decode 吞吐率**。生成输出 Token 的实时速率 (tokens/s)。 |
| **`npu_cache_usage_perc`** | Gauge | **NPU KV Cache 利用率**。昇腾卡显存中 KV Cache 的占用比例 (0-1)。 |
| **`cpu_cache_usage_perc`** | Gauge | **CPU Block Cache 利用率**。当发生 Swap 时，主机内存中 Cache 的占用比例。 |
| **`npu_prefix_cache_hit_rate`** | Gauge | **前缀缓存命中率**。NPU 上 Prefix Cache 的复用命中率。 |

### 3.3 时延与分布 (Latency & Distribution)

| 指标名称 | 类型 | 中文含义与解释 |
| :--- | :--- | :--- |
| **`time_to_first_token_seconds`** | Histogram | **首字时延 (TTFT)**。请求生成首个 Token 的纯推理耗时。 |
| **`time_per_output_token_seconds`** | Histogram | **字间时延 (TPOT)**。连续生成两个 Token 之间的时间间隔。 |
| **`e2e_request_latency_seconds`** | Histogram | **端到端时延**。请求从接收到完成的消耗时间。 |
| **`request_prompt_tokens`** | Histogram | **输入 Token 数分布**。统计请求输入的长度分布情况。 |
| **`request_generation_tokens`** | Histogram | **输出 Token 数分布**。统计请求输出的长度分布情况。 |
| **`failed_request_perc`** | Gauge | **请求失败率**。当前时间窗口内的失败请求占比 (0-1)。 |