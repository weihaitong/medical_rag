***

# 大模型推理引擎监控指标统一映射指南 (v1.0)

**适用引擎**：vLLM, SGLang, MindIE  
**文档用途**：解决不同推理引擎原生 Metrics 命名不一致问题，建立统一的监控大盘（Dashboard）和告警规则。

---

## 一、 核心指标映射总表

本表将三个引擎的异构指标映射到统一的监控语义。

### 1. 流量与吞吐类 (Traffic & Throughput)

| 统一监控语义 | 统一指标命名建议 (Target Name) | vLLM 原生指标 | SGLang 原生指标 | MindIE 原生指标 | 类型 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **请求成功吞吐量**<br>(Output QPS/TPS) | `llm_request_success_total` | `vllm:request_success_total` | (无直接对应，需用 total - failed) | `request_success_total` | Counter |
| **请求到达量**<br>(Input QPS/RPS) | `llm_request_arrival_total` | `vllm:request_received_total`<br>*(部分版本支持)* | `sglang:num_requests_total` | `request_received_total` | Counter |
| **输入 Token 总量**<br>(Prompt Tokens) | `llm_prompt_tokens_total` | `vllm:prompt_tokens_total` | `sglang:prompt_tokens_total` | `request_prompt_tokens_count`<br>*(Histogram count)* | Counter |
| **输出 Token 总量**<br>(Generation Tokens) | `llm_generation_tokens_total` | `vllm:generation_tokens_total` | `sglang:generation_tokens_total` | `request_generation_tokens_count`<br>*(Histogram count)* | Counter |

> **⚠️ 重点说明**：
> *   **vLLM / MindIE** 的 `success_total` 代表**出口流量**（处理完成量）。
> *   **SGLang** 的 `num_requests_total` 代表**入口流量**（接收量）。
> *   **建议**：监控大盘展示 QPS 时，建议统一使用 `rate(xxx_success_total)` 计算有效吞吐；展示系统负载压力时，使用 `rate(xxx_received/requests_total)`。

### 2. 时延与体验类 (Latency & Experience)

| 统一监控语义 | 统一指标命名建议 (Target Name) | vLLM 原生指标 | SGLang 原生指标 | MindIE 原生指标 | 类型 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **首字时延**<br>(TTFT) | `llm_ttft_seconds` | `vllm:time_to_first_token_seconds` | `sglang:time_to_first_token_seconds` | `time_to_first_token_seconds` | Histogram |
| **字间时延**<br>(TPOT/ITL) | `llm_tpot_seconds` | `vllm:time_per_output_token_seconds` | `sglang:inter_token_latency_seconds` | `time_per_output_token_seconds` | Histogram |
| **端到端时延**<br>(E2E Latency) | `llm_e2e_seconds` | `vllm:e2e_request_latency_seconds` | `sglang:e2e_request_latency_seconds` | `e2e_request_latency_seconds` | Histogram |

### 3. 饱和度与并发类 (Saturation & Concurrency)

| 统一监控语义 | 统一指标命名建议 (Target Name) | vLLM 原生指标 | SGLang 原生指标 | MindIE 原生指标 | 类型 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **正在推理并发数**<br>(Running Reqs) | `llm_active_requests` | `vllm:num_requests_running` | `sglang:num_running_reqs` | `num_requests_running` | Gauge |
| **排队等待请求数**<br>(Waiting Reqs) | `llm_waiting_requests` | `vllm:num_requests_waiting` | `sglang:num_queue_reqs` | `num_requests_waiting` | Gauge |
| **显存/KV Cache利用率**<br>(Cache Usage) | `llm_cache_usage_ratio` | `vllm:gpu_cache_usage_perc` | *(需计算)*<br>`used_tokens / max_tokens` | `npu_cache_usage_perc` | Gauge |

---

## 二、 关键指标差异详解

### 1. QPS 的定义差异
*   **vLLM (`vllm:request_success_total`)**:
    *   **含义**: 请求处理完成并成功返回给客户端的时刻计数 +1。
    *   **用途**: 衡量系统**实际产出能力**。如果系统过载，排队严重，此指标可能远低于前端请求量。
*   **SGLang (`sglang:num_requests_total`)**:
    *   **含义**: Router 收到 HTTP 请求的时刻计数 +1。
    *   **用途**: 衡量**前端流量压力**。包含被拒绝、失败、排队中的请求。

### 2. Cache 利用率的计算差异
*   **vLLM / MindIE**: 直接提供百分比（0.0 ~ 1.0）。
    *   `vllm:gpu_cache_usage_perc`
    *   `npu_cache_usage_perc`
*   **SGLang**: 未直接提供百分比 Gauge，需通过 Token 数计算。
    *   公式：`sglang:num_used_tokens` / `sglang:max_total_num_tokens`

### 3. Token 生成速率 (Throughput)
*   **SGLang / MindIE**: 提供了预计算好的 Gauge 指标（如 `gen_throughput`），表示瞬时速率。
*   **vLLM**: 不直接提供瞬时速率 Gauge。
*   **统一方案**: 为了保证口径一致，**强烈建议**忽略引擎自带的速率 Gauge，统一在 Prometheus 使用 `rate()` 函数计算：
    ```promql
    rate(llm_generation_tokens_total[1m])
    ```

---

## 三、 Prometheus Recording Rules 配置模板

建议将以下规则应用到 Prometheus 配置中，即可在 Grafana 中使用统一的 `llm_*` 开头指标查询所有引擎。

```yaml
groups:
  - name: llm_inference_unified
    rules:
      # ===============================
      # 1. 吞吐量 (Throughput) - Counter Rate
      # ===============================
      # 统一请求成功率 (Effective QPS)
      - record: llm:request_success_rate_1m
        expr: >
          rate(vllm:request_success_total[1m])
          or rate(request_success_total{engine="mindie"}[1m])
          or rate(sglang:num_requests_total[1m]) # 注：SGLang暂用Total近似，如有failed指标应相减

      # 统一输出 Token 速率 (Generation TPS)
      - record: llm:generation_tokens_rate_1m
        expr: >
          rate(vllm:generation_tokens_total[1m])
          or rate(generation_tokens_total{engine="mindie"}[1m])
          or rate(sglang:generation_tokens_total[1m])

      # ===============================
      # 2. 负载 (Load) - Gauge
      # ===============================
      # 统一活跃并发数
      - record: llm:active_requests
        expr: >
          vllm:num_requests_running
          or sglang:num_running_reqs
          or num_requests_running{engine="mindie"}

      # 统一排队数 (关键告警指标)
      - record: llm:waiting_requests
        expr: >
          vllm:num_requests_waiting
          or sglang:num_queue_reqs
          or num_requests_waiting{engine="mindie"}

      # 统一 KV Cache 利用率 (归一化到 0-1)
      - record: llm:cache_usage_ratio
        expr: >
          vllm:gpu_cache_usage_perc
          or npu_cache_usage_perc
          or (sglang:num_used_tokens / sglang:max_total_num_tokens)

      # ===============================
      # 3. 时延 (Latency) - Histogram
      # ===============================
      # 统一 TTFT (P95)
      - record: llm:ttft_seconds_p95
        expr: >
          histogram_quantile(0.95, sum by (le, pod, model) (rate(vllm:time_to_first_token_seconds_bucket[1m])))
          or histogram_quantile(0.95, sum by (le, pod, model) (rate(sglang:time_to_first_token_seconds_bucket[1m])))
          or histogram_quantile(0.95, sum by (le, pod, model) (rate(time_to_first_token_seconds_bucket{engine="mindie"}[1m])))
```